# Exercise


이 파이썬 스크립트(`name.py`)를 한국어로 자세히 설명해 드리겠습니다.

**스크립트의 전체적인 목적:**

이 스크립트는 `greetings.db`라는 간단한 SQLite 데이터베이스 파일에 저장된 이름 목록을 관리하기 위한 커맨드 라인 도구입니다. 다음과 같은 기능을 제공합니다:

1. 데이터베이스에 새 이름 **추가**
2. 기존 이름 **수정**
3. 이름 **삭제**
4. 저장된 모든 이름 **목록 보기 (출력)**
5. 데이터베이스 **초기화/리셋** (기존 데이터 모두 삭제 후 테이블 구조 재생성)

**주요 구성 요소:**

1. **`DB_NAME = 'greetings.db'`** : 스크립트가 실행되는 디렉토리에 생성되거나 사용될 SQLite 데이터베이스 파일의 이름을 정의하는 상수입니다.
2. **`DatabaseManager` 클래스** :

* **목적** : 안전하고 신뢰성 있는 데이터베이스 상호작용을 위한 핵심 부분입니다.  **컨텍스트 관리자** (`__enter__`와 `__exit__` 메서드 사용) 역할을 합니다.
* **`__init__(self, db_name: str)`** : 클래스 인스턴스를 만들 때 데이터베이스 파일 이름을 저장합니다.
* **`__enter__(self)`** : `with db_manager as conn:` 구문처럼 `with` 문 안에서 `DatabaseManager` 인스턴스를 사용할 때 호출됩니다. SQLite 데이터베이스에 연결을 시도하고, 성공하면 연결 객체(`conn`)를 반환합니다. 연결 실패 시 오류 메시지를 출력하고 스크립트를 종료합니다.
* **`__exit__(self, exc_type, exc_val, exc_tb)`** : `with` 블록이 성공적으로 완료되었든, 오류가 발생했든 상관없이 *항상* 자동으로 호출됩니다.
  * 오류가 없으면 (`exc_type is None`), `with` 블록 내에서 변경된 내용을 데이터베이스에 `commit`(저장)하려고 시도합니다. 커밋 중 발생할 수 있는 오류도 처리합니다.
  * `with` 블록 내에서 오류가 발생했다면 (`exc_type`이 `None`이 아님), 해당 블록 내에서 수행된 모든 변경 사항을 `rollback`(취소)하여 데이터 무결성을 유지합니다. 롤백되었음을 알리는 메시지를 출력합니다.
  * 마지막으로, 항상 데이터베이스 연결을 `close`(종료)하여 리소스를 적절히 해제합니다.
* **장점** : 이 클래스를 `with` 문과 함께 사용하면 데이터베이스 연결이 항상 닫히고, 트랜잭션(작업 단위)이 적절하게 저장(커밋)되거나 취소(롤백)되도록 보장하여 데이터베이스 작업을 훨씬 안전하고 깔끔하게 만듭니다.

1. **데이터베이스 함수 (`initialize_db`, `reset_db`, `add_name`, `update_name`, `delete_name`, `print_all_names`)** :

* 각 함수는 특정 데이터베이스 작업(테이블 생성, 테이블 삭제/재생성, 삽입, 업데이트, 삭제, 조회)을 수행합니다.
* 모두 `DatabaseManager` 인스턴스를 인수로 받습니다.
* 모두 `with db_manager as conn:` 패턴을 사용하여 `DatabaseManager` 클래스를 통해 안전한 연결 처리, 커밋, 롤백을 보장합니다.
* **`initialize_db`** : `names` 테이블이 없으면 생성합니다. 테이블에는 자동으로 증가하는 `id`와 `UNIQUE`(고유)해야 하는 `name` 열이 있습니다.
* **`reset_db`** : 먼저 사용자에게 확인을 요청합니다. 확인되면 기존 `names` 테이블을 `DROP`(삭제)하고 (모든 데이터 삭제) 다시 생성합니다.
* **`add_name`** : 이름 삽입을 시도합니다. `name` 열의 `UNIQUE` 제약 조건을 영리하게 활용합니다. 이름이 이미 존재하면 SQLite는 `IntegrityError`를 발생시키고, 함수는 이를 잡아 사용자에게 알리고 `False`를 반환합니다. 성공하면 `True`를 반환합니다.
* **`update_name`** : 이전 이름이 존재하는지 확인합니다. 존재하면 새 이름으로 업데이트를 시도합니다. 새 이름이 이미 존재할 수 있는 경우(`IntegrityError`)를 처리합니다.
* **`delete_name`** : 이름 삭제를 시도합니다. `cursor.rowcount`를 확인하여 실제로 행이 영향을 받았는지(즉, 이름이 존재했는지) 확인하고 그에 따라 보고합니다.
* **`print_all_names`** : 데이터베이스에서 모든 이름을 선택하고 알파벳순으로 정렬한 다음 번호와 함께 콘솔에 출력합니다.

1. **`main()` 함수** :

* **진입점** : 스크립트가 직접 실행될 때 실행이 시작되는 곳입니다.
* **인수 파싱 (`argparse`)** : 커맨드 라인 인수(옵션) 처리를 설정합니다.
  * `-i`/`--input NAME`: 이름 추가.
  * `-u`/`--update OLD_NAME NEW_NAME`: 이름 변경 (두 개의 인수 필요).
  * `-d`/`--delete NAME`: 이름 삭제.
  * `-o`/`--output`: 모든 이름 목록 보기.
  * `-init`/`--initialize`: 데이터베이스 초기화/리셋.
  * `--test-error`: 롤백 메커니즘 테스트를 위한 내부 옵션.
  * `add_mutually_exclusive_group`: 주요 작업(`-i`, `-u`, `-d`, `-o`) 중 하나만 동시에 지정할 수 있도록 보장합니다.
* **로직 흐름** :
  1. `DatabaseManager` 인스턴스를 생성합니다.
  1. 사용자가 커맨드 라인에 입력한 인수를 파싱(분석)합니다.
  1. `--initialize` 옵션이 주어졌는지 확인하고, 그렇다면 `reset_db`를 호출하고 종료합니다.
  1. 주요 작업(`-i`, `-u`, `-d`, `-o`)이나 `--initialize`가 주어지지 않았다면, 도움말 메시지를 출력하고 종료합니다.
  1. 주요 작업이 주어졌다면 (`--initialize`가 아님), (`--test-error`가 사용되지 않는 한) `initialize_db`를 호출하여 데이터베이스 테이블이 존재하는지 확인한 후 다음 작업을 진행합니다.
  1. 롤백 디버깅/테스트를 위해 `--test-error` 플래그를 처리합니다.
  1. 파싱된 인수(`args.input`, `args.update` 등)에 따라 해당 데이터베이스 함수(`add_name`, `update_name` 등)를 호출합니다.
  1. `add_name` 부분에는 중복된 이름을 추가하려고 할 경우 사용자에게 다른 이름을 입력하라는 메시지를 표시하고 다시 시도하는 루프가 포함되어 있습니다.

1. **`if __name__ == "__main__":`** : 이 표준 파이썬 구문은 스크립트가 직접 실행될 때 (`python name.py ...`처럼)만 `main()` 함수가 호출되고, 다른 스크립트에서 모듈로 임포트(import)될 때는 호출되지 않도록 보장합니다.

**사용 방법 (예시):**


# "Alice" 이름 추가

python name.py -i Alice

# "Alice" 다시 추가 시도 (오류 메시지가 표시됨)

python name.py -i Alice

# "Alice"를 "Alicia"로 변경

python name.py -u Alice Alicia

# "Bob" 추가

python name.py -i Bob

# 모든 이름 목록 보기

python name.py -o

# "Alicia" 삭제

python name.py -d Alicia

# 다시 이름 목록 보기

python name.py -o

# 데이터베이스 초기화 (확인 메시지가 표시됨)

python name.py --initialize

# 인수 없이 실행 (도움말이 표시됨)

python name.py


요약하자면, 이 스크립트는 SQLite를 사용하여 기본적인 이름 관리를 수행하는 잘 구조화된 커맨드 라인 유틸리티입니다. 특히 `DatabaseManager` 클래스를 통해 안전한 데이터베이스 연결 관리(자동 커밋/롤백/닫기)를 구현했으며, 커맨드 라인 인터페이스 처리와 데이터베이스 로직을 명확하게 분리한 점이 특징입니다.
